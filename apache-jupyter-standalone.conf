# Configuration Apache pour JupyterLab Standalone avec support WebSockets
# À placer sur serverweb (192.168.1.202)
# Fichier : /etc/apache2/sites-available/jupyter.leumaire.fr.conf

<VirtualHost *:80>
    ServerName jupyter.leumaire.fr
    ServerAdmin contact@leumaire.fr

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/jupyter_error.log
    CustomLog ${APACHE_LOG_DIR}/jupyter_access.log combined

    # Configuration du proxy vers JupyterLab standalone (vm-ia:8889)
    ProxyPreserveHost On
    ProxyRequests Off

    # Headers pour le proxy
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Host "jupyter.leumaire.fr"

    # Proxy HTTP classique
    ProxyPass / http://192.168.1.96:8889/
    ProxyPassReverse / http://192.168.1.96:8889/

    # Support WebSockets (ESSENTIEL pour JupyterLab - exécution de code)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://192.168.1.96:8889/$1" [P,L]

    # Alternative avec ProxyPass WebSocket
    <Location />
        ProxyPass http://192.168.1.96:8889/ upgrade=websocket
        ProxyPassReverse http://192.168.1.96:8889/
        ProxyPreserveHost On
    </Location>

    # Configuration spécifique pour les kernels et terminaux (WebSocket)
    <LocationMatch "/(api/kernels|terminals)/(.*)">
        ProxyPass http://192.168.1.96:8889/ upgrade=websocket
        ProxyPassReverse http://192.168.1.96:8889/
        ProxyPreserveHost On
    </LocationMatch>

    # Authentification HTTP Basic (recommandé)
    <Location />
        AuthType Basic
        AuthName "JupyterLab Access"
        AuthUserFile /etc/apache2/.htpasswd
        Require valid-user
    </Location>
</VirtualHost>

# Configuration HTTPS (à activer après certbot)
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName jupyter.leumaire.fr
    ServerAdmin contact@leumaire.fr

    # Certificats SSL (générés automatiquement par certbot)
    # SSLEngine on
    # SSLCertificateFile /etc/letsencrypt/live/jupyter.leumaire.fr/fullchain.pem
    # SSLCertificateKeyFile /etc/letsencrypt/live/jupyter.leumaire.fr/privkey.pem

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/jupyter_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/jupyter_ssl_access.log combined

    # Configuration identique au port 80
    ProxyPreserveHost On
    ProxyRequests Off

    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Host "jupyter.leumaire.fr"

    # Proxy HTTP
    ProxyPass / http://192.168.1.96:8889/
    ProxyPassReverse / http://192.168.1.96:8889/

    # WebSockets
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://192.168.1.96:8889/$1" [P,L]

    <Location />
        ProxyPass http://192.168.1.96:8889/ upgrade=websocket
        ProxyPassReverse http://192.168.1.96:8889/
        ProxyPreserveHost On
    </Location>

    <LocationMatch "/(api/kernels|terminals)/(.*)">
        ProxyPass http://192.168.1.96:8889/ upgrade=websocket
        ProxyPassReverse http://192.168.1.96:8889/
        ProxyPreserveHost On
    </LocationMatch>

    # Authentification
    <Location />
        AuthType Basic
        AuthName "JupyterLab Access"
        AuthUserFile /etc/apache2/.htpasswd
        Require valid-user
    </Location>
</VirtualHost>
</IfModule>
